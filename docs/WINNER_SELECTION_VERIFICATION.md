# Winner Selection & On-Chain Verification Guide

## üé≤ How Winners Are Drawn

The SUI Raffle Bot uses **provably fair, on-chain randomness** from the SUI blockchain to ensure completely transparent and verifiable winner selection.

---

## Drawing Process

### Step 1: Raffle Completion
When the raffle end time is reached, an admin runs the `/award_prize` command to draw the winner.

### Step 2: Ticket Collection
The system collects all buy events (token purchases) from the database:

```typescript
// Fetches all purchases during the raffle period
const tickets = await prisma.buyEvent.findMany({
  where: { 
    raffleId: raffle.id,
    timestamp: { gte: raffle.startTime, lte: raffle.endTime }
  }
});
```

**Example Database:**
| User | Wallet Address | Tickets | Timestamp |
|------|---------------|---------|-----------|
| Alice | 0xabc...123 | 500 | 2025-11-01 10:00 |
| Bob | 0xdef...456 | 1000 | 2025-11-02 14:30 |
| Alice | 0xabc...123 | 300 | 2025-11-03 09:15 |
| Carol | 0xghi...789 | 700 | 2025-11-04 16:45 |

**Total Tickets:** 2,500

### Step 3: Request On-Chain Random Number

The bot requests a cryptographically secure random number from the SUI blockchain:

```typescript
const randomBigInt = await suiClient.getRandomNumber();
```

**SUI Randomness Source:**
- Uses **drand beacon** (Distributed Randomness Beacon)
- Network: https://drand.love
- Generated at SUI epoch boundaries
- 256-bit cryptographic entropy
- Publicly verifiable and auditable

**Example Random Number:**
```
BigInt: 98765432109876543210987654321098765432109876543210
```

### Step 4: Calculate Winning Ticket

```typescript
// Total tickets in the raffle
const totalTickets = 2500;

// Calculate winning ticket number (1-indexed)
const winningTicketNumber = Number(randomBigInt % BigInt(totalTickets)) + 1;
```

**Example Calculation:**
```
Random Number: 98765432109876543210987654321098765432109876543210
Modulo Operation: 98765432109876543210987654321098765432109876543210 % 2500 = 1210
Winning Ticket: #1210
```

### Step 5: Determine Winner

The system uses cumulative ticket counting to find who owns the winning ticket:

```typescript
let cumulativeTickets = 0;
for (const buyEvent of tickets) {
  cumulativeTickets += buyEvent.ticketCount;
  if (winningTicketNumber <= cumulativeTickets) {
    winner = buyEvent;
    break;
  }
}
```

**Ticket Range Distribution:**
| Buy Event | User | Tickets | Cumulative | Ticket Range |
|-----------|------|---------|------------|-------------|
| #1 | Alice | 500 | 500 | 1 - 500 |
| #2 | Bob | 1000 | 1500 | 501 - 1500 |
| #3 | Alice | 300 | 1800 | 1501 - 1800 |
| #4 | Carol | 700 | 2500 | 1801 - 2500 |

**In this example:** Ticket #1210 falls in Bob's range ‚Üí **Bob wins!** üèÜ

### Step 6: Record Winner

```typescript
await prisma.winner.create({
  data: {
    raffleId: raffle.id,
    walletAddress: winner.walletAddress,
    ticketCount: winner.ticketCount,
    selectedAt: new Date(),
    randomNumber: randomBigInt.toString(), // Stored for verification
    winningTicketNumber: winningTicketNumber
  }
});
```

### Step 7: Announce Winner

The bot announces the winner in the main chat:
```
üéâ WINNER SELECTED! üéâ

üèÜ Winner: 0xdef...456
üé´ Winning Ticket: #1210
üìä Total Tickets: 2,500
üë• Total Participants: 3
üí∞ Prize: 1000 AQUA

Congratulations! üéä
```

---

## üîç On-Chain Verification

### Why Verification Matters

Anyone can verify that the winner was selected fairly by checking:
1. The random number came from SUI blockchain (not generated by the bot)
2. The calculation was done correctly
3. The winner owns the winning ticket number

### How to Verify

#### Step 1: Get Raffle Information

Run `/raffle_info <raffle_id>` (or check the announcement) to get:
- Raffle ID
- Winner's wallet address
- Winning ticket number
- Random number used
- Total tickets
- Timestamp

#### Step 2: Verify SUI Random Number

The random number is generated by SUI's randomness beacon at specific epochs.

**Check on SUI Explorer:**
```
1. Go to: https://suiscan.xyz/mainnet/home
2. Navigate to: Randomness ‚Üí Beacon History
3. Find the epoch matching the draw timestamp
4. Verify the random value matches what was announced
```

**Alternative - Query via RPC:**
```bash
curl -X POST https://fullnode.mainnet.sui.io:443 \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "suix_getRandomnessAtEpoch",
    "params": [<epoch_number>]
  }'
```

#### Step 3: Verify Ticket Calculation

You can independently verify the winner by:

**Get all buy events:**
```sql
SELECT walletAddress, ticketCount, timestamp
FROM BuyEvent
WHERE raffleId = '<raffle_id>'
ORDER BY timestamp ASC;
```

**Calculate yourself:**
```javascript
// 1. Sum total tickets
const totalTickets = buyEvents.reduce((sum, e) => sum + e.ticketCount, 0);

// 2. Apply modulo to random number
const winningTicket = (randomNumber % totalTickets) + 1;

// 3. Find winner by cumulative count
let cumulative = 0;
for (const event of buyEvents) {
  cumulative += event.ticketCount;
  if (winningTicket <= cumulative) {
    console.log(`Winner: ${event.walletAddress}`);
    break;
  }
}
```

#### Step 4: Verify Ticket Ownership

Check the blockchain for actual token purchases:

**Query SUI blockchain:**
```bash
# Get all transactions for the raffle contract address
sui client call --package <package_id> \
  --module raffle \
  --function get_purchases \
  --args <raffle_id>
```

This shows all on-chain transactions that earned tickets.

---

## üîê Security & Fairness Guarantees

### 1. **Unpredictable Randomness**
- Random number is generated by distributed network (drand)
- No single party controls the randomness
- Generated AFTER all purchases are complete
- Cannot be predicted or manipulated

### 2. **Transparent Process**
- All buy events are public in the database
- Random number is publicly verifiable on SUI blockchain
- Calculation formula is open source
- Anyone can reproduce the winner selection

### 3. **Weighted Distribution**
- More tokens purchased = More tickets = Higher probability
- Probability is exactly proportional to purchase amount
- No hidden advantages or disadvantages

### 4. **Immutable Records**
- All transactions recorded on SUI blockchain
- Buy events stored in PostgreSQL with timestamps
- Winner selection recorded with random number
- Full audit trail maintained

---

## üìä Probability Calculation

Your chance of winning is calculated as:

```
Your Probability = (Your Total Tickets / Total Raffle Tickets) √ó 100%
```

**Example:**
- You bought: 1,500 tokens ‚Üí 1,500 tickets
- Total raffle tickets: 10,000
- Your probability: (1,500 / 10,000) √ó 100% = **15%**

---

## üõ°Ô∏è Anti-Manipulation Features

### 1. **No Admin Control**
- Admins cannot choose the winner
- Admins cannot influence the random number
- Process is fully automated

### 2. **Time-Locked**
- Random number requested AFTER raffle ends
- No purchases allowed after end time
- Winner selection uses final ticket state

### 3. **Blockchain-Backed**
- All purchases verified on-chain
- Random number from decentralized source
- Tamper-proof transaction history

### 4. **Open Source**
- Code is public on GitHub
- Community can audit the logic
- No hidden behavior

---

## üìù Example Verification Walkthrough

Let's verify a real raffle draw:

**Raffle Details:**
- Raffle ID: `ckAbc123...`
- End Time: 2025-11-07 23:59:59 UTC
- Winner: `0xdef456...`
- Winning Ticket: #1,843
- Random Number: `12345678901234567890123456789012345678901234567890`
- Total Tickets: 5,000

**Verification Steps:**

1. **Check SUI Explorer for epoch randomness:**
   - Go to SUI Explorer
   - Find epoch for timestamp: 2025-11-07 23:59:59 UTC
   - Verify random value: `12345678901234567890123456789012345678901234567890`

2. **Calculate winning ticket:**
   ```
   12345678901234567890123456789012345678901234567890 % 5000 = 1843
   Winning Ticket: #1843 ‚úì
   ```

3. **Query buy events:**
   ```sql
   SELECT * FROM BuyEvent WHERE raffleId = 'ckAbc123...' ORDER BY timestamp;
   ```

4. **Calculate cumulative tickets:**
   ```
   Alice: 800 tickets ‚Üí Range 1-800
   Bob: 1200 tickets ‚Üí Range 801-2000
   Carol: 1500 tickets ‚Üí Range 2001-3500  ‚Üê #1843 is here!
   Dave: 1500 tickets ‚Üí Range 3501-5000
   ```

5. **Verify winner:**
   - Ticket #1843 falls in Carol's range (2001-3500)
   - Announced winner: Carol (`0xdef456...`)
   - **Verification: PASSED ‚úÖ**

---

## üîó Additional Resources

- **SUI Randomness Documentation:** https://docs.sui.io/concepts/cryptography/transaction-auth/randomness
- **drand Network:** https://drand.love
- **Winner Selection Code:** `src/services/winner-service.ts`
- **Verification Script:** `scripts/verify-winner.ts` (coming soon)

---

## ‚ùì Frequently Asked Questions

### Can the admin manipulate the winner?
**No.** The random number comes from the SUI blockchain, which is decentralized and cannot be controlled by any single party.

### When is the random number generated?
**After the raffle ends.** The random number is requested only when `/award_prize` is called, ensuring no one can predict it during the raffle.

### Can I verify the winner myself?
**Yes!** Follow the verification steps above. All data is public and verifiable on-chain.

### What if two people have the same ticket count?
The winner is determined by the **specific buy event**, not just the user. If you made multiple purchases, each one has a separate chance based on when you bought.

### Is this provably fair?
**Yes!** The system uses cryptographic randomness from a distributed network, transparent calculations, and public verification. This is as fair as mathematically possible.

---

## üéØ Summary

‚úÖ **Winner selection uses SUI blockchain randomness**  
‚úÖ **Process is fully transparent and auditable**  
‚úÖ **Anyone can verify the winner independently**  
‚úÖ **Probability is proportional to tokens purchased**  
‚úÖ **No possibility of manipulation by admins or users**  

The raffle system is designed to be **provably fair, transparent, and secure** for all participants! üé≤‚ú®
